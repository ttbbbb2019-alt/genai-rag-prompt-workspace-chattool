FROM quay.io/unstructured-io/unstructured:0.15.6 as builder

USER root
RUN rm -rf /usr/local/share/tessdata && \
    pip uninstall -y `pip freeze | grep torch` && \
    pip uninstall -y `pip freeze | grep nvidia` && \
    pip install --no-cache-dir torch==2.3.0+cpu -f https://download.pytorch.org/whl/torch_stable.html && \
    apk add --no-cache tesseract-eng

WORKDIR /app
COPY file-import-batch-job/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt && \
    rm -rf example-docs test_unstructured /tmp/* /var/cache/apk/*

FROM scratch 
COPY --from=builder / /

USER notebook-user
WORKDIR /app
COPY layers/python-sdk/python/ .
COPY file-import-batch-job/main.py ./main.py

CMD ["python3", "main.py"]